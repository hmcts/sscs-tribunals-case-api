#Pull request needs to have the pr-values:ccd label to deploy this stack.
tags:
  sscs-ccd-idam-pr: true

java:
  image: ${IMAGE_NAME}
  ingressHost: ${SERVICE_FQDN}
  memoryLimits: "8Gi"
  memoryRequests: "1Gi"
  cpuRequests: "2"
  cpuLimits: 2000m
  readinessDelay: 45
  environment:
    PDF_API_URL: "http://rpe-pdf-service-aat.service.core-compute-aat.internal"
    DOCUMENT_MANAGEMENT_URL: "http://dm-store-aat.service.core-compute-aat.internal"
    BUNDLE_URL: http://${SERVICE_NAME}-em-ccdorc
    CCD_UI_BASE_URL: https://${SERVICE_NAME}-case-management-web
    IDAM_S2S_AUTH: "http://rpe-service-auth-provider-aat.service.core-compute-aat.internal"
    IDAM_API_URL: https://idam-api.aat.platform.hmcts.net
    IDAM_OAUTH2_REDIRECT_URL: ${IDAM_OAUTH2_REDIRECT_URL}
    IDAM_API_JWK_URL: https://idam-api.aat.platform.hmcts.net/jwks
    MANAGE_CASE_UI_BASE_URL: https://${SERVICE_NAME}-xui
    IDAM_OAUTH2_CLIENT_ID: ${IDAM_OAUTH2_CLIENT_ID}
    IDAM_OAUTH2_CLIENT_SECRET: ${IDAM_OAUTH2_CLIENT_SECRET}
    IDAM_S2S-AUTH_TOTP_SECRET: ${IDAM_S2S_AUTH_TOTP_SECRET}
    IDAM_S2S-AUTH_MICROSERVICE: ${IDAM_S2S_AUTH_MICROSERVICE}
    IDAM_SSCS_SYSTEMUPDATE_USER: ${IDAM_SSCS_SYSTEMUPDATE_USER}
    IDAM_SSCS_SYSTEMUPDATE_PASSWORD: ${IDAM_SSCS_SYSTEMUPDATE_PASSWORD}
    CCD_CALLBACK_ORCHESTRATOR_API_URL: http://${SERVICE_NAME}-sscs-ccd-callback-orchestrator
    CORE_CASE_DATA_JURISDICTION_ID: SSCS
    CORE_CASE_DATA_CASE_TYPE_ID: Benefit
    TEST_URL: http://${SERVICE_NAME}
    CREATE_CCD_ENDPOINT: true
    CASE_ACCESS_MANAGEMENT_FEATURE: true
    WORK_ALLOCATION_FEATURE: true
    SCHEDULE_LISTING_FEATURE: true
    POST_HEARINGS_FEATURE: true
    POST_HEARINGS_B_FEATURE: true
    ADJOURNMENT_FEATURE: true
    GAPS_SWITCHOVER_FEATURE: true
    ELASTIC_SEARCH_FEATURE: true
    ELINKS_V2_FEATURE_ENABLED: true
    DUMMY: true
    HEARINGS_EVENT_QUEUE_NAME: ${SERVICE_NAME}-servicebus-tribunals-to-hearing-api
  secrets:
    HEARINGS_EVENT_SERVICE_BUS_CONNECTION_STRING:
      secretRef: sscs-sb-preview
      key: connectionString


em-ccdorc:
  enabled: true
  java:
    image: hmctspublic.azurecr.io/em/ccdorc:latest
    releaseNameOverride: ${SERVICE_NAME}-em-ccdorc
    ingressHost: em-ccdorc-${SERVICE_FQDN}
    environment:
      IDAM_API_BASE_URI: https://idam-api.aat.platform.hmcts.net
      OPEN_ID_API_BASE_URI: https://idam-web-public.aat.platform.hmcts.net/o
      S2S_BASE_URI: http://rpe-service-auth-provider-aat.service.core-compute-aat.internal
      EM_STITCHING_API_URL: http://em-stitching-aat.service.core-compute-aat.internal
      DM_STORE_APP_URL: http://dm-store-aat.service.core-compute-aat.internal
      CCD_DATA_API_URL: http://ccd-data-store-api-aat.service.core-compute-aat.internal
      CALLBACK_HTTP_SCHEME: https
      CALLBACK_DOMAIN: em-ccdorc-${SERVICE_FQDN}

ccd-case-document-am-api:
  enabled: false
  java:
    image: hmctspublic.azurecr.io/ccd/case-document-am-api:latest
    releaseNameOverride: ${SERVICE_NAME}-ccd-case-document-am-api
    environment:
      CCD_DATA_STORE_API_BASE_URL: http://${SERVICE_NAME}-ccd-data-store-api
      IDAM_API_URL: https://idam-api.aat.platform.hmcts.net
      IDAM_OIDC_URL: https://idam-web-public.aat.platform.hmcts.net
      OIDC_ISSUER: https://forgerock-am.service.core-compute-idam-aat.internal:8443/openam/oauth2/hmcts
      S2S_URL: http://rpe-service-auth-provider-aat.service.core-compute-aat.internal
      DM_STORE_BASE_URL: http://dm-store-aat.service.core-compute-aat.internal

xui-webapp:
  enabled: true
  nodejs:
    memoryLimits: "4Gi"
    cpuLimits: 2000m
    memoryRequests: "1Gi"
    cpuRequests: "1"
    imagePullPolicy: Always
    releaseNameOverride: ${SERVICE_NAME}-xui-webapp
    image: hmctspublic.azurecr.io/xui/webapp:latest
    ingressHost: xui-${SERVICE_FQDN}
    environment:
      HEALTH_TERMS_AND_CONDITIONS_API: http://${SERVICE_NAME}-xui-terms-and-conditions/health
      SERVICES_CCD_CASE_ASSIGNMENT_API: http://${SERVICE_NAME}-aac
      SERVICES_TERMS_AND_CONDITIONS: http://${SERVICE_NAME}-xui-terms-and-conditions
      SERVICES_IDAM_API_URL: https://idam-api.aat.platform.hmcts.net
      SERVICES_S2S: http://rpe-service-auth-provider-aat.service.core-compute-aat.internal
      SERVICES_HEARINGS_COMPONENT_API: http://jurisdiction-hearings-api-aat.service.core-compute-aat.internal
      SERVICES_HMC_HEARINGS_COMPONENT_API: http://${SERVICE_NAME}-hmc-cft-hearing-service
      SERVICES_PRD_LOCATION_API: http://rd-location-ref-api-aat.service.core-compute-aat.internal
      SERVICES_PRD_JUDICIAL_API: http://rd-judicial-api-aat.service.core-compute-aat.internal
      SERVICES_PRD_COMMONDATA_API: http://rd-commondata-api-aat.service.core-compute-aat.internal
      SERVICES_DOCUMENTS_API_V2: http://${SERVICE_NAME}-ccd-case-document-am-api
      GLOBAL_SEARCH_SERVICES: IA,CIVIL,PRIVATELAW,PUBLICLAW,SSCS
      JURISDICTIONS: SSCS
      LAUNCH_DARKLY_CLIENT_ID: 5de6610b23ce5408280f2268
      FEATURE_REDIS_ENABLED: false
      FEATURE_APP_INSIGHTS_ENABLED: false
      FEATURE_SECURE_COOKIE_ENABLED: false
      FEATURE_PROXY_ENABLED: false
      FEATURE_TERMS_AND_CONDITIONS_ENABLED: false
      FEATURE_HELMET_ENABLED: false
      FEATURE_OIDC_ENABLED: false
      ALLOW_CONFIG_MUTATIONS: true
      FEATURE_JRD_E_LINKS_V2_ENABLED: true
      NOW: false
      REDISCLOUD_URL: http://dummyrediscloudurl
      UV_THREADPOOL_SIZE: 128
      PROTOCOL: http
      SERVICES_HEARINGS_COMPONENT_API_SSCS: http://sscs-hearings-api-aat.service.core-compute-aat.internal
    keyVaults:
      rpx:
        resourceGroup: rpx
        secrets:
          - mc-s2s-client-secret
          - mc-idam-client-secret
          - system-user-name
          - system-user-password

elastic:
  enabled: true

sscs-evidence-share:
  enabled: true
  java:
    image: hmctspublic.azurecr.io/sscs/evidence-share:latest
    releaseNameOverride: ${SERVICE_NAME}-sscs-evidence-share
    environment:
      SEND_LETTER_SERVICE_ENABLED: "true"
      SEND_LETTER_SERVICE_BASEURL: "http://rpe-send-letter-service-aat.service.core-compute-aat.internal"
      IDAM_API_URL: https://idam-api.aat.platform.hmcts.net
      DOCUMENT_MANAGEMENT_URL: "http://dm-store-aat.service.core-compute-aat.internal"
      CORE_CASE_DATA_API_URL: http://ccd-data-store-api-aat.service.core-compute-aat.internal
      TOPIC_NAME: "${SERVICE_NAME}-servicebus-main-topic"
      SUBSCRIPTION_NAME: "${SERVICE_NAME}-servicebus-main-topic"
      AMQP_HOST: "sscs-sb-preview.servicebus.windows.net"
      AMQP_USERNAME: "RootManageSharedAccessKey"
      ROBOTICS_EMAIL_FROM: "sscs@hmcts.net"
      ROBOTICS_EMAIL_TO: "fake"
      ROBOTICS_EMAIL_SCOTTISH_TO: "fake2"
      ROBOTICS_EMAIL_PIP_AE_TO: "fake3"
      CASE_ACCESS_MANAGEMENT_FEATURE: true
      ISSUE_GENERIC_LETTER: true
    secrets:
      AMQP_PASSWORD:
        secretRef: sscs-sb-preview
        key: primaryKey

# tya disabled by default due of requirements of additional topic subscriptions which is not possible currently configure and should be done manually
# if your PR requires tya-notif change enabled to true
# deploy to preview as usual
# and when go to azure portal and search for sscs-sb-preview
# click topics and select your PR topic
# click subscriptions and click add subscription button (+ subscription)
# into name field add name: sscs-tribunals-api-pr-##YOUR PR NUMBER ##-servicebus-tya (example: sscs-tribunals-api-pr-3290-servicebus-tya)
# click create
# azure steps should be repeated every time PR is undeployed from preview
sscs-tya-notif:
  enabled: false
  java:
    image: hmctspublic.azurecr.io/sscs/tya-notif:latest
    releaseNameOverride: ${SERVICE_NAME}-sscs-tya-notification
    readinessDelay: 45
    environment:
      CORE_CASE_DATA_API_URL: "http://ccd-data-store-api-aat.service.core-compute-aat.internal"
      AMQP_HOST: "sscs-sb-preview.servicebus.windows.net"
      AMQP_USERNAME: "RootManageSharedAccessKey"
      TOPIC_NAME: "${SERVICE_NAME}-servicebus-main-topic"
      SUBSCRIPTION_NAME: "${SERVICE_NAME}-servicebus-tya"
      JOB_SCHEDULER_DB_NAME: "sscsjobscheduler"
      JOB_SCHEDULER_DB_HOST: ${SERVICE_NAME}-postgresql
      JOB_SCHEDULER_DB_CONNECTION_OPTIONS: "?stringtype=unspecified&ssl=disable&gssEncMode=disable"
      JOB_SCHEDULER_DB_USERNAME: hmcts
      JOB_SCHEDULER_DB_PASSWORD: hmcts
      HOURS_START_TIME: 0
      HOURS_END_TIME: 23
      RUN_DB_MIGRATION_ON_STARTUP: true
      TEST_RECIPIENTS_POSTCODE: "*"
      POST_HEARINGS_FEATURE: true
      POST_HEARINGS_B_FEATURE: true
      DUMMY: true
    secrets:
      AMQP_PASSWORD:
        secretRef: sscs-sb-preview
        key: primaryKey
    keyVaults:
      sscs:
        secrets:
          - idam-api
          - idam-oauth-user
          - idam-redirect
          - idam-sscs-systemupdate-user
          - idam-sscs-systemupdate-password
          - sscs-email-mac-secret-text
          - idam-sscs-oauth2-client-secret
          - sscs-s2s-secret
          - s2s-micro
          - evidence-share-topic-shared-access-key
          - docmosis-api-key
          - notification-key
          - notification-test-key

sscs-ccd-callback-orchestrator:
  enabled: true
  java:
    ingressHost: cbo-${SERVICE_FQDN}
    image: hmctspublic.azurecr.io/sscs/ccd-callback-orchestrator:latest
    releaseNameOverride: ${SERVICE_NAME}-sscs-ccd-callback-orchestrator
    readinessDelay: 90
    environment:
      SUBSCRIPTION_NAME: "${SERVICE_NAME}-servicebus-main-topic"
      TOPIC_NAME: "${SERVICE_NAME}-servicebus-main-topic"
      AMQP_HOST: "sscs-sb-preview.servicebus.windows.net"
      AMQP_USERNAME: "RootManageSharedAccessKey"
    secrets:
      AMQP_PASSWORD:
        secretRef: sscs-sb-preview
        key: primaryKey


#Enable for SYA
sscs-tribunals-frontend:
  enabled: true
  nodejs:
    memoryLimits: "2Gi"
    cpuLimits: 2000m
    image: hmctspublic.azurecr.io/sscs/tribunals-frontend:latest
    ingressHost: sya-${SERVICE_FQDN}
    environment:
      REDIS_URL: redis://${SERVICE_NAME}-redis-master
      APPINSIGHTS_ROLE_NAME: ${SERVICE_NAME}
      PCQ_URL: "https://pcq.aat.platform.hmcts.net"
      FT_ANTENNA_WEBCHAT: false
      FT_WELSH: true
      PCQ_ENABLED: true
      MULTIPLE_DRAFTS_ENABLED: true
      ALLOW_CONFIG_MUTATIONS: true
      TRIBUNALS_CASE_API_URL: http://${SERVICE_NAME}-java
      UPLOAD_EVIDENCE_URL: http://${SERVICE_NAME}/evidence/upload
      SERVICES_IDAM_LOGIN_URL: https://idam-web-public.aat.platform.hmcts.net/login
      SERVICES_IDAM_API_URL: https://idam-api.aat.platform.hmcts.net
      UV_THREADPOOL_SIZE: 64
    keyVaults:
      sscs:
        secrets:
          - idam-sscs-oauth2-client-secret
          - postcode-lookup-token
          - AppInsightsInstrumentationKey
          - pcq-token-key
          - sscs-redis-access-key
          - sscs-redis-connection-string

redis:
  enabled: true
  replica:
    replicaCount: 0
  cluster:
    enabled: false
    slaveCount: 0
  usePassword: false
  master:
    persistence:
      enabled: false

#Turning either hearings api (with either listener on) or cft hearing service on requires
#service bus to be turned on.
sscs-hearings-api:
  enabled: true
  java:
    image: "hmctspublic.azurecr.io/sscs/hearings-api:pr-562-02322ee-20240116112926" #Change to pr if required
    releaseNameOverride: ${SERVICE_NAME}-sscs-hearings-api
    ingressHost: hearings-${SERVICE_FQDN}
    environment:
      ROOT_LOGGING_LEVEL: INFO
      SSCS_LOG_LEVEL: DEBUG #Switch to debug to see requests being sent.
      SERVICE_BUS_LOG_LEVEL: ERROR
      LOG_OUTPUT: single
      CREATE_CCD_ENDPOINT: false
      IDAM_S2S_URL: "http://rpe-service-auth-provider-aat.service.core-compute-aat.internal"
      CASEWORKER_REF_API_URL: "http://rd-caseworker-ref-api-aat.service.core-compute-aat.internal"
      IDAM_API_URL: "https://idam-api.aat.platform.hmcts.net"
      CORE_CASE_DATA_API_URL: "http://ccd-data-store-api-aat.service.core-compute-aat.internal"
      COMMON_REF_API_URL: "http://rd-commondata-api-aat.service.core-compute-aat.internal"
      JUDICIAL_REF_API_URL: "http://rd-judicial-api-aat.service.core-compute-aat.internal"
      EXUI_API_URL: "https://${SERVICE_NAME}-xui"
      HMC_API_URL: "http://hmc-cft-hearing-service-aat.service.core-compute-aat.internal"
      #Messaging
      HMC_HEARINGS_LISTENING_ENABLED: true
      HMC_HEARINGS_TOPIC_NAME: "hmc-to-cft-aat"
      HMC_HEARINGS_TOPIC_SUBSCRIPTION_NAME: "hmc-to-sscs-subscription-aat"
      TRIBUNALS_HEARINGS_LISTENING_ENABLED: true
      TRIBUNALS_EVENT_QUEUE_NAME: ${SERVICE_NAME}-servicebus-tribunals-to-hearing-api
      TRIBUNALS_EVENT_QUEUE_POLICY_NAME: RootManageSharedAccessKey
      TRIBUNALS_EVENT_QUEUE_NAMESPACE: sscs-sb-preview
      HMC_HEARINGS_TOPIC_NAMESPACE: hmc-servicebus-aat
      HMC_DEPLOYMENT_ID: deployment-${SERVICE_NAME}
      DUMMY: false
    secrets:
      TRIBUNALS_EVENT_QUEUE_ACCESS_KEY:
        secretRef: sscs-sb-preview
        key: primaryKey
    keyVaults:
      sscs:
        secrets:
          - name: hmc-servicebus-shared-access-key-tf
            alias: HMC_HEARINGS_TOPIC_ACCESS_KEY
          - name: sscs-hearing-manager-username
            alias: IDAM_SSCS_SYSTEMUPDATE_USER
          - name: sscs-hearing-manager-pass
            alias: IDAM_SSCS_SYSTEMUPDATE_PASSWORD
          - name: app-insights-connection-string
            alias: app-insights-connection-string
          - name: sscs-s2s-secret
            alias: IDAM_S2S_AUTH_TOTP_SECRET
          - name: idam-oauth-user
            alias: IDAM_OAUTH2_CLIENT_ID
          - name: idam-sscs-oauth2-client-secret
            alias: IDAM_OAUTH2_CLIENT_SECRET
    terraformEnvironmentVariables:
      TF_VAR_deploymentId: hearing-deployment-${SERVICE_NAME}

#Enable for queues/topics
#If you need a subscription for a topic, topic name should be not longer than 10 characters
servicebus:
  enabled: true
  resourceGroup: sscs-aso-preview-rg
  sbNamespace: sscs-servicebus-preview
  #Each topic/queue matches up to one used in the config above
  setup:
    topics:
      - name: main-topic
        subscriptionNeeded: yes
    queues:
      - name: sscs-orchestrator-queue-preview
      - name: tribunals-to-hearing-api